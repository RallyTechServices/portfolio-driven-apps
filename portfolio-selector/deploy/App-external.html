<!DOCTYPE html>
<html>
<head>
    <title>portfolio-selector</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.override(Rally.ui.filter.CustomFilterRow,{_getItems:function(){var items=[{xtype:"rallycombobox",itemId:"fieldCombobox",disabled:!0,autoLoad:!1,defaultSelectionPosition:null,store:Ext.create("Ext.data.Store",{fields:["attributeDefinition","displayName","modelNames","name"]}),displayField:"displayName",emptyText:"Choose Field...",valueField:"name",matchFieldWidth:!0,listeners:{select:this._onFieldSelect,afterrender:this._onFieldAfterRender,expand:this._onFieldExpand,scope:this},width:this.boxWidths.field,filterProperties:["displayName"],listConfig:{itemTpl:new Ext.XTemplate("{displayName}",'<tpl if="this.hasModelNames(values)">','<div class="duplicate-field-model-name">- {modelNames}</div>',"</tpl>",{hasModelNames:function(data){return data.modelNames.length>0}})}},{xtype:"rallycombobox",itemId:"operatorCombobox",disabled:!0,autoLoad:!1,editable:!1,forceSelection:!0,store:Ext.create("Ext.data.Store",{fields:["name","displayName"],listeners:{datachanged:this._onOperatorDataChanged,scope:this}}),displayField:"displayName",valueField:"name",matchFieldWidth:!0,listeners:{setvalue:this._onOperatorSetValue,scope:this},width:this.boxWidths.operator}];return this._hasInitialData()||items.push({xtype:"rallytextfield",itemId:"valueField",disabled:!0,height:22,width:this.boxWidths.value}),items}}),Ext.override(Rally.ui.filter.CustomFilterPanel,{_getItems:function(){return[{xtype:"container",cls:"custom-filter-header",layout:"column",defaults:{xtype:"component",cls:"filter-panel-label"},items:[{height:1,width:30},{html:"Field",width:this.boxWidths.field+5||135},{html:"Operator",width:this.boxWidths.operator+5||140},{html:"Value",width:this.boxWidths.value+5||155}]},{xtype:"container",itemId:"customFilterRows"}]}}),Ext.override(Ext.util.Filter,{createFilterFn:function(){var me=this,matcher=me.createValueMatcher(),property=me.property;return!Ext.isArray(me.property)&&/,/.test(me.property)&&(property=me.property.split(",")),function(item){for(var hasmatch=!1,i=0;i<property.length;i++)if(matcher.test(me.getRoot.call(me,item)[property[i]])){hasmatch=!0;break}return null===matcher?null===me.value:hasmatch}}}),Ext.override(Rally.ui.combobox.ComboBox,{doLocalQuery:function(queryPlan){var me=this,queryString=queryPlan.query;me.queryFilter||(me.queryFilter=new Ext.util.Filter({id:me.id+"-query-filter",anyMatch:!0,caseSensitive:!1,root:"data",property:me.filterProperties}),me.store.addFilter(me.queryFilter,!1)),queryString||!queryPlan.forceAll?(me.queryFilter.disabled=!1,me.queryFilter.setValue(me.enableRegEx?new RegExp(queryString):queryString)):me.queryFilter.disabled=!0,me.store.filter(),me.store.getCount()?me.expand():me.collapse(),me.afterQuery(queryPlan)}}),Ext.define("Rally.technicalservices.PortfolioParentComboBox",{extend:"Rally.ui.combobox.FieldValueComboBox",_loadStoreValues:function(){this.field.getAllowedValueStore().load({requester:this,callback:function(records,operation,success){var store=this.store;if(store){var noEntryValues=[],labelValues=_.map(_.filter(records,this._hasStringValue),this._convertAllowedValueToLabelValuePair,this);if("boolean"===this.field.getType())labelValues=labelValues.concat([this._convertToLabelValuePair("Yes",!0),this._convertToLabelValuePair("No",!1)]);else if(this.field.required===!1){var name="-- No Entry --",value="";this.getUseNullForNoEntryValue()&&(value=null),"rating"===this.field.attributeDefinition.AttributeType.toLowerCase()&&(name=this.getRatingNoEntryString(),value="None"),noEntryValues.push(this._convertToLabelValuePair(name,value))}store.loadRawData(noEntryValues.concat(labelValues)),store.fireEvent("load",store,store.getRange(),success)}},scope:this})},_hasStringValue:function(allowedValueObject){return""!==allowedValueObject.get("StringValue")}});
                Ext.define("portfolioDrivenApps.common.PortfolioSelectorWidget",{extend:"Ext.Container",componentCls:"app",alias:"widget.portfolioselector",layout:"hbox",width:"100%",mixins:["Rally.Messageable","Ext.state.Stateful"],stateful:!0,stateEvents:["change"],type:null,buttonText:"Go",buttonPushed:!1,constructor:function(config){this.type=config.type,this.callParent(arguments)},initComponent:function(){this.callParent(arguments),this.removeAll(),this._addSelector(),this.subscribe(this,"requestPortfolioItem",this._requestPorfolioItem,this)},getState:function(){return this.portfolioItem?{portfolioItemRef:this.portfolioItem.get("_ref")}:null},applyState:function(state){},_updatePortfolioItem:function(){this.buttonPushed=!0;var cb=this.down("#cb-portfolioitem");if(cb){var portfolioItem=cb.getRecord();this.portfolioItem=portfolioItem,this.fireEvent("change",portfolioItem),this.publish("portfolioItemSelected",portfolioItem),this.stateful&&this.stateId&&this.saveState()}},_addSelector:function(){if(this.removeAll(),this.type){var cb=Ext.create("Rally.ui.combobox.ComboBox",{storeConfig:{model:this.type,fetch:["FormattedID","ObjectID","Name"],remoteFilter:!1,autoLoad:!0,limit:1/0},allowNoEntry:!0,noEntryText:"",noEntryValue:0,itemId:"cb-portfolioitem",margin:10,valueField:"ObjectID",displayField:"FormattedID",width:600,listConfig:{itemTpl:'<tpl if="ObjectID &gt; 0">{FormattedID}: {Name}</tpl>'},filterProperties:["Name","FormattedID","ObjectID"],fieldCls:"pi-selector",displayTpl:'<tpl for="."><tpl if="ObjectID &gt; 0 ">{[values["FormattedID"]]}: {[values["Name"]]}</tpl><tpl if="xindex < xcount">,</tpl></tpl>'});cb.on("change",this._updateGoButton,this),this.add(cb),this.add({xtype:"rallybutton",text:this.buttonText,itemId:"cb-go-button",cls:"rly-small primary",disabled:!0,margin:10,listeners:{scope:this,click:this._updatePortfolioItem}})}else this.add({xtype:"container",html:'<div class="message">Please configure a selector type in the app settings.</div>',padding:10})},_updateGoButton:function(cb){!Ext.isEmpty(cb.getValue())&&cb.getValue()>0?this.down("#cb-go-button").setDisabled(!1):this.down("#cb-go-button").setDisabled(!0)},_requestPorfolioItem:function(){return this.buttonPushed?void this.publish("portfolioItemSelected",this.portfolioItem||null):void console.log("Requested PI, but the user hasn't pushed the Go button")}});
                Ext.define("portfolioDrivenApps.common.WsapiToolbox",{singleton:!0,fetchWsapiCount:function(model,query_filters){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:model,fetch:["ObjectID"],filters:query_filters,limit:1,pageSize:1}).load({callback:function(records,operation,success){success?deferred.resolve(operation.resultSet.totalRecords):deferred.reject(Ext.String.format("Error getting {0} count for {1}: {2}",model,query_filters.toString(),operation.error.errors.join(",")))}}),deferred},fetchModelTypePathByTypeDefinition:function(typeDef){var deferred=Ext.create("Deft.Deferred"),typeDefId=0;return typeDef&&(typeDefId=typeDef.replace("/typedefinition/","")),Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Name"],filters:[{property:"ObjectID",value:typeDefId}]}).load({callback:function(records,operation,success){success&&records&&records.length>0?deferred.resolve(records[0].get("TypePath")):deferred.resolve(null)}}),deferred},fetchWsapiRecords:function(model,query_filters,fetch_fields,context){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:model,fetch:fetch_fields,filters:query_filters,context:context,limit:1/0}).load({callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject(Ext.String.format("Error getting {0} for {1}: {2}",model,query_filters.toString(),operation.error.errors.join(",")))}}),deferred},fetchReleases:function(timebox){var deferred=Ext.create("Deft.Deferred"),rec=timebox.getRecord();return null===rec&&deferred.resolve([]),Ext.create("Rally.data.wsapi.Store",{model:"Release",fetch:["ObjectID"],filters:[{property:"Name",value:rec.get("Name")},{property:"ReleaseStartDate",value:rec.get("ReleaseStartDate")},{property:"ReleaseDate",value:rec.get("ReleaseDate")}],limit:1/0}).load({callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject("Error loading Releases: "+operation.error.errors.join(","))}}),deferred},fetchAllowedValues:function(model,field_name){var deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:model,success:function(model){model.getField(field_name).getAllowedValueStore().load({callback:function(records){var values=Ext.Array.map(records,function(record){return record.get("StringValue")});deferred.resolve(values)}})},failure:function(msg){deferred.reject("Error loading field values: "+msg)}}),deferred},fetchPortfolioItemTypes:function(){var deferred=Ext.create("Deft.Deferred"),store=Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Ordinal","Name"],filters:[{property:"TypePath",operator:"contains",value:"PortfolioItem/"}],sorters:[{property:"Ordinal",direction:"ASC"}]});return store.load({callback:function(records,operation,success){if(success){var portfolioItemTypes=new Array(records.length);_.each(records,function(d){var idx=Number(d.get("Ordinal"));portfolioItemTypes[idx]={typePath:d.get("TypePath"),name:d.get("Name")}}),deferred.resolve(portfolioItemTypes)}else{var error_msg="";operation&&operation.error&&operation.error.errors&&(error_msg=operation.error.errors.join(",")),deferred.reject("Error loading Portfolio Item Types:  "+error_msg)}}}),deferred.promise},fetchDoneStates:function(){var deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"HierarchicalRequirement",success:function(model){var field=model.getField("ScheduleState");field.getAllowedValueStore().load({callback:function(records,operation,success){if(success){for(var values=[],i=records.length-1;i>0;i--)values.push(records[i].get("StringValue")),"Accepted"===records[i].get("StringValue")&&(i=0);deferred.resolve(values)}else deferred.reject("Error loading ScheduleState values for User Story:  "+operation.error.errors.join(","))},scope:this})},failure:function(){var error="Could not load schedule states";deferred.reject(error)}}),deferred.promise},fetchTypeDefinition:function(typePath){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Name"],filters:[{property:"TypePath",value:typePath}]}).load({callback:function(records,operation,success){if(success&&records&&records.length>0)deferred.resolve(records[0]);else{var message="No records returned when loading Type Definition for "+typePath;success||(message="Error loading Type Definition for "+typePath+":  "+operation.error.errors.join(",")),deferred.reject(message)}}}),deferred}});
                Ext.define("portfolioSelectorApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this._addSelector()},_addSelector:function(){this.removeAll(),this.add({xtype:"portfolioitemselector",type:this.getSetting("selectorType"),stateId:this.getContext().getScopedStateId("app-selector"),flex:1})},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})},isExternal:function(){return"undefined"==typeof this.getAppId()},onSettingsUpdate:function(settings){Ext.apply(this,settings),this._addSelector()},getSettingsFields:function(){var filters=[{property:"TypePath",operator:"contains",value:"PortfolioItem/"}];return[{name:"selectorType",xtype:"rallycombobox",allowBlank:!1,autoSelect:!1,shouldRespondToScopeChange:!0,fieldLabel:"Results Type",context:this.getContext(),storeConfig:{model:Ext.identityFn("TypeDefinition"),sorters:[{property:"DisplayName"}],fetch:["DisplayName","ElementName","TypePath","Parent","UserListable"],filters:filters,autoLoad:!1,remoteSort:!1,remoteFilter:!0},displayField:"DisplayName",valueField:"TypePath",readyEvent:"ready"}]}});

            Rally.launchApp('portfolioSelectorApp', {
                name:"portfolio-selector",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
