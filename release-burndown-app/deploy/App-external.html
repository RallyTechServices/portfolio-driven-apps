<!DOCTYPE html>
<html>
<head>
    <title>release-burndown-app</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("portfolioDrivenApps.common.WsapiToolbox",{singleton:!0,fetchWsapiCount:function(model,query_filters){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:model,fetch:["ObjectID"],filters:query_filters,limit:1,pageSize:1}).load({callback:function(records,operation,success){success?deferred.resolve(operation.resultSet.totalRecords):deferred.reject(Ext.String.format("Error getting {0} count for {1}: {2}",model,query_filters.toString(),operation.error.errors.join(",")))}}),deferred},fetchModelTypePathByTypeDefinition:function(typeDef){var deferred=Ext.create("Deft.Deferred"),typeDefId=0;return typeDef&&(typeDefId=typeDef.replace("/typedefinition/","")),Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Name"],filters:[{property:"ObjectID",value:typeDefId}]}).load({callback:function(records,operation,success){success&&records&&records.length>0?deferred.resolve(records[0].get("TypePath")):deferred.resolve(null)}}),deferred},fetchWsapiRecords:function(model,query_filters,fetch_fields,context){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:model,fetch:fetch_fields,filters:query_filters,context:context,limit:1/0}).load({callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject(Ext.String.format("Error getting {0} for {1}: {2}",model,query_filters.toString(),operation.error.errors.join(",")))}}),deferred},fetchReleases:function(timebox){var deferred=Ext.create("Deft.Deferred"),rec=timebox.getRecord();return null===rec&&deferred.resolve([]),Ext.create("Rally.data.wsapi.Store",{model:"Release",fetch:["ObjectID"],filters:[{property:"Name",value:rec.get("Name")},{property:"ReleaseStartDate",value:rec.get("ReleaseStartDate")},{property:"ReleaseDate",value:rec.get("ReleaseDate")}],limit:1/0}).load({callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject("Error loading Releases: "+operation.error.errors.join(","))}}),deferred},fetchAllowedValues:function(model,field_name){var deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:model,success:function(model){model.getField(field_name).getAllowedValueStore().load({callback:function(records){var values=Ext.Array.map(records,function(record){return record.get("StringValue")});deferred.resolve(values)}})},failure:function(msg){deferred.reject("Error loading field values: "+msg)}}),deferred},fetchPortfolioItemTypes:function(){var deferred=Ext.create("Deft.Deferred"),store=Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Ordinal","Name"],filters:[{property:"TypePath",operator:"contains",value:"PortfolioItem/"}],sorters:[{property:"Ordinal",direction:"ASC"}]});return store.load({callback:function(records,operation,success){if(success){var portfolioItemTypes=new Array(records.length);_.each(records,function(d){var idx=Number(d.get("Ordinal"));portfolioItemTypes[idx]={typePath:d.get("TypePath"),name:d.get("Name")}}),deferred.resolve(portfolioItemTypes)}else{var error_msg="";operation&&operation.error&&operation.error.errors&&(error_msg=operation.error.errors.join(",")),deferred.reject("Error loading Portfolio Item Types:  "+error_msg)}}}),deferred.promise},fetchDoneStates:function(){var deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"HierarchicalRequirement",success:function(model){var field=model.getField("ScheduleState");field.getAllowedValueStore().load({callback:function(records,operation,success){if(success){for(var values=[],i=records.length-1;i>0;i--)values.push(records[i].get("StringValue")),"Accepted"===records[i].get("StringValue")&&(i=0);deferred.resolve(values)}else deferred.reject("Error loading ScheduleState values for User Story:  "+operation.error.errors.join(","))},scope:this})},failure:function(){var error="Could not load schedule states";deferred.reject(error)}}),deferred.promise},fetchTypeDefinition:function(typePath){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Name"],filters:[{property:"TypePath",value:typePath}]}).load({callback:function(records,operation,success){if(success&&records&&records.length>0)deferred.resolve(records[0]);else{var message="No records returned when loading Type Definition for "+typePath;success||(message="Error loading Type Definition for "+typePath+":  "+operation.error.errors.join(",")),deferred.reject(message)}}}),deferred}});
                Ext.override(Rally.ui.filter.CustomFilterRow,{_getItems:function(){var items=[{xtype:"rallycombobox",itemId:"fieldCombobox",disabled:!0,autoLoad:!1,defaultSelectionPosition:null,store:Ext.create("Ext.data.Store",{fields:["attributeDefinition","displayName","modelNames","name"]}),displayField:"displayName",emptyText:"Choose Field...",valueField:"name",matchFieldWidth:!0,listeners:{select:this._onFieldSelect,afterrender:this._onFieldAfterRender,expand:this._onFieldExpand,scope:this},width:this.boxWidths.field,filterProperties:["displayName"],listConfig:{itemTpl:new Ext.XTemplate("{displayName}",'<tpl if="this.hasModelNames(values)">','<div class="duplicate-field-model-name">- {modelNames}</div>',"</tpl>",{hasModelNames:function(data){return data.modelNames.length>0}})}},{xtype:"rallycombobox",itemId:"operatorCombobox",disabled:!0,autoLoad:!1,editable:!1,forceSelection:!0,store:Ext.create("Ext.data.Store",{fields:["name","displayName"],listeners:{datachanged:this._onOperatorDataChanged,scope:this}}),displayField:"displayName",valueField:"name",matchFieldWidth:!0,listeners:{setvalue:this._onOperatorSetValue,scope:this},width:this.boxWidths.operator}];return this._hasInitialData()||items.push({xtype:"rallytextfield",itemId:"valueField",disabled:!0,height:22,width:this.boxWidths.value}),items}}),Ext.override(Rally.ui.filter.CustomFilterPanel,{_getItems:function(){return[{xtype:"container",cls:"custom-filter-header",layout:"column",defaults:{xtype:"component",cls:"filter-panel-label"},items:[{height:1,width:30},{html:"Field",width:this.boxWidths.field+5||135},{html:"Operator",width:this.boxWidths.operator+5||140},{html:"Value",width:this.boxWidths.value+5||155}]},{xtype:"container",itemId:"customFilterRows"}]}}),Ext.override(Ext.util.Filter,{createFilterFn:function(){var me=this,matcher=me.createValueMatcher(),property=me.property;return!Ext.isArray(me.property)&&/,/.test(me.property)&&(property=me.property.split(",")),function(item){for(var hasmatch=!1,i=0;i<property.length;i++)if(matcher.test(me.getRoot.call(me,item)[property[i]])){hasmatch=!0;break}return null===matcher?null===me.value:hasmatch}}}),Ext.override(Rally.ui.combobox.ComboBox,{doLocalQuery:function(queryPlan){var me=this,queryString=queryPlan.query;me.queryFilter||(me.queryFilter=new Ext.util.Filter({id:me.id+"-query-filter",anyMatch:!0,caseSensitive:!1,root:"data",property:me.filterProperties}),me.store.addFilter(me.queryFilter,!1)),queryString||!queryPlan.forceAll?(me.queryFilter.disabled=!1,me.queryFilter.setValue(me.enableRegEx?new RegExp(queryString):queryString)):me.queryFilter.disabled=!0,me.store.filter(),me.store.getCount()?me.expand():me.collapse(),me.afterQuery(queryPlan)}}),Ext.define("Rally.technicalservices.PortfolioParentComboBox",{extend:"Rally.ui.combobox.FieldValueComboBox",_loadStoreValues:function(){this.field.getAllowedValueStore().load({requester:this,callback:function(records,operation,success){var store=this.store;if(store){var noEntryValues=[],labelValues=_.map(_.filter(records,this._hasStringValue),this._convertAllowedValueToLabelValuePair,this);if("boolean"===this.field.getType())labelValues=labelValues.concat([this._convertToLabelValuePair("Yes",!0),this._convertToLabelValuePair("No",!1)]);else if(this.field.required===!1){var name="-- No Entry --",value="";this.getUseNullForNoEntryValue()&&(value=null),"rating"===this.field.attributeDefinition.AttributeType.toLowerCase()&&(name=this.getRatingNoEntryString(),value="None"),noEntryValues.push(this._convertToLabelValuePair(name,value))}store.loadRawData(noEntryValues.concat(labelValues)),store.fireEvent("load",store,store.getRange(),success)}},scope:this})},_hasStringValue:function(allowedValueObject){return""!==allowedValueObject.get("StringValue")}});
                Ext.define("portfolioDrivenApps.common.PortfolioSelectorWidget",{extend:"Ext.Container",componentCls:"app",alias:"widget.portfolioselector",layout:"hbox",width:"100%",mixins:["Rally.Messageable","Ext.state.Stateful"],stateful:!0,stateEvents:["change"],type:null,buttonText:"Go",buttonPushed:!1,constructor:function(config){this.type=config.type,this.callParent(arguments)},initComponent:function(){this.callParent(arguments),this.removeAll(),this._addSelector(),this.subscribe(this,"requestPortfolioItem",this._requestPorfolioItem,this)},getState:function(){return this.portfolioItem?{portfolioItemRef:this.portfolioItem.get("_ref")}:null},_updatePortfolioItem:function(){this.buttonPushed=!0;var cb=this.down("#cb-portfolioitem");if(cb){var portfolioItem=cb.getRecord();this.portfolioItem=portfolioItem,this.fireEvent("change",portfolioItem),this.publish("portfolioItemSelected",portfolioItem),this.stateful&&this.stateId&&this.saveState()}},_addSelector:function(){if(this.removeAll(),this.type){var cb=Ext.create("Rally.ui.combobox.ComboBox",{storeConfig:{model:this.type,fetch:["FormattedID","ObjectID","Name"],remoteFilter:!1,autoLoad:!0,limit:1/0},allowNoEntry:!0,noEntryText:"",noEntryValue:0,itemId:"cb-portfolioitem",margin:10,valueField:"ObjectID",displayField:"FormattedID",width:600,listConfig:{itemTpl:'<tpl if="ObjectID &gt; 0">{FormattedID}: {Name}</tpl>'},filterProperties:["Name","FormattedID","ObjectID"],fieldCls:"pi-selector",displayTpl:'<tpl for="."><tpl if="ObjectID &gt; 0 ">{[values["FormattedID"]]}: {[values["Name"]]}</tpl><tpl if="xindex < xcount">,</tpl></tpl>'});cb.on("change",this._updateGoButton,this),this.add(cb),this.add({xtype:"rallybutton",text:this.buttonText,itemId:"cb-go-button",cls:"rly-small primary",disabled:!0,margin:10,listeners:{scope:this,click:this._updatePortfolioItem}})}else this.add({xtype:"container",html:'<div class="message">Please configure a selector type in the app settings.</div>',padding:10})},_updateGoButton:function(cb){!Ext.isEmpty(cb.getValue())&&cb.getValue()>0?this.down("#cb-go-button").setDisabled(!1):this.down("#cb-go-button").setDisabled(!0)},_requestPorfolioItem:function(){return this.buttonPushed?void this.publish("portfolioItemSelected",this.portfolioItem||null):void console.log("Requested PI, but the user hasn't pushed the Go button")}});
                Ext.define("portfolioDrivenApps.common.appBase",{extend:"Rally.app.App",componentCls:"app",launch:function(){this.fetchPortfolioItemTypes().then({success:function(portfolioItemTypes){this.portfolioItemTypes=portfolioItemTypes,this.addComponents()},failure:function(msg){Rally.ui.notify.Notifier.showError({message:msg})},scope:this})},showAppMessage:function(container,msg){container.add({xtype:"container",html:Ext.String.format('<div class="no-data-container"><div class="secondary-message">{0}</div></div>',msg)})},showErrorMessage:function(container,msg){container.add({xtype:"container",html:Ext.String.format('<div class="no-data-container"><div class="secondary-message" style="color:red;">{0}</div></div>',msg)})},isReleaseScoped:function(){return this.getContext().getTimeboxScope()&&"release"===this.getContext().getTimeboxScope().getType()||!1},addComponents:function(){this.removeAll(),this.headerContainer=this.add({xtype:"container",itemId:"header-ct",layout:{type:"hbox"}}),this.getSetting("showScopeSelector")===!0||"true"===this.getSetting("showScopeSelector")?this.headerContainer.add({xtype:"portfolioselector",context:this.getContext(),type:this.getSetting("selectorType"),stateId:this.getContext().getScopedStateId("app-selector"),width:"75%",listeners:{change:this.updatePortfolioItem,scope:this}}):(this.subscribe(this,"portfolioItemSelected",this.updatePortfolioItem,this),this.publish("requestPortfolioItem",this))},updatePortfolioItem:function(portfolioItemRecord){this.portfolioItem=portfolioItemRecord},getSettingsFields:function(){var filters=[{property:"TypePath",operator:"contains",value:"PortfolioItem/"}];return[{name:"showScopeSelector",xtype:"rallycheckboxfield",fieldLabel:"Show Scope Selector",bubbleEvents:["change"]},{name:"selectorType",xtype:"rallycombobox",allowBlank:!1,autoSelect:!1,shouldRespondToScopeChange:!0,fieldLabel:"Selector Type",context:this.getContext(),storeConfig:{model:Ext.identityFn("TypeDefinition"),sorters:[{property:"DisplayName"}],fetch:["DisplayName","ElementName","TypePath","Parent","UserListable"],filters:filters,autoLoad:!1,remoteSort:!1,remoteFilter:!0},displayField:"DisplayName",valueField:"TypePath",readyEvent:"ready",handlesEvents:{change:function(chk){this.setDisabled(chk.getValue()!==!0)}}}]},fetchPortfolioItemTypes:function(){var deferred=Ext.create("Deft.Deferred"),store=Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Ordinal","Name"],filters:[{property:"TypePath",operator:"contains",value:"PortfolioItem/"}],sorters:[{property:"Ordinal",direction:"ASC"}]});return store.load({callback:function(records,operation,success){if(success){var portfolioItemTypes=new Array(records.length);_.each(records,function(d){var idx=Number(d.get("Ordinal"));portfolioItemTypes[idx]={typePath:d.get("TypePath"),name:d.get("Name")}}),deferred.resolve(portfolioItemTypes)}else{var error_msg="";operation&&operation.error&&operation.error.errors&&(error_msg=operation.error.errors.join(",")),deferred.reject("Error loading Portfolio Item Types:  "+error_msg)}}}),deferred.promise},fetchWsapiRecords:function(config){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",config).load({callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject(Ext.String.format("Error getting {0} for {1}: {2}",config.model,config.filters.toString(),operation.error.errors.join(",")))}}),deferred}});
                Ext.define("portfolioDrivenApps.releaseBurndownApp.BurndownCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",getMetrics:function(){return[{field:"PlanEstimate",as:"Planned",display:"line",f:"sum"},{field:"PlanEstimate",as:"Remaining",f:"filteredSum",filterField:"ScheduleState",filterValues:["Defined","In-Progress","Completed"],display:"column"}]},getSummaryMetricsConfig:function(){var me=this;return[{as:"Remaining_intercept",f:function(seriesData){var mb=me.calculateSlopeAndIntercept(seriesData,"Remaining");return mb.intercept}},{as:"Remaining_slope",f:function(seriesData){var mb=me.calculateSlopeAndIntercept(seriesData,"Remaining");return mb.slope}}]},getDerivedFieldsAfterSummary:function(){return[{as:"Trend",f:function(snapshot,index,metrics){return isNaN(metrics.Remaining_intercept)||isNaN(metrics.Remaining_slope)?null:metrics.Remaining_intercept+metrics.Remaining_slope*index},display:"line"}]},calculateSlopeAndIntercept:function(seriesData,attribute){for(var sum_xy=0,sum_x=0,sum_y=0,sum_x_squared=0,n=0,i=0;i<seriesData.length;i++)seriesData[i][attribute]&&(sum_xy+=seriesData[i][attribute]*i,sum_x+=i,sum_y+=seriesData[i][attribute],sum_x_squared+=i*i,n++);var slope=(n*sum_xy-sum_x*sum_y)/(n*sum_x_squared-sum_x*sum_x),intercept=(sum_y-slope*sum_x)/n;return{slope:slope,intercept:intercept}}});
                Ext.define("releaseBurndownApp",{extend:"portfolioDrivenApps.common.appBase",componentCls:"app",RELEASE_SCOPE_MSG:"This app is designed for an Release scoped dashboard.  Please update the current dashboard to have an Release scope.",PORTFOLIO_MSG:"Please select a Portfolio Item.",launch:function(){this.callParent(arguments),this.updateView()},updatePortfolioItem:function(portfolioItemRecord){this.portfolioItem=portfolioItemRecord,this.updateView(portfolioItemRecord)},getDisplayBox:function(){return this.down("#displayBox")||this.add({xtype:"container",itemId:"displayBox"}),this.down("#displayBox")},getTimeboxScope:function(){return this.getContext().getTimeboxScope()},onTimeboxScopeChange:function(timeboxScope){timeboxScope||(timeboxScope=this.getContext().getTimeboxScope()),timeboxScope&&"release"===timeboxScope.getType()&&(this.getContext().setTimeboxScope(timeboxScope),this.updateView())},updateView:function(){return this.getDisplayBox().removeAll(),this.getTimeboxScope()?this.portfolioItem?void this.fetchPortfolioItemsInRelease(this.portfolioItem).then({success:this.buildBurndown,failure:this.showErrorMessage,scope:this}):void this.showAppMessage(this.getDisplayBox(),this.PORTFOLIO_MSG):void this.showAppMessage(this.getDisplayBox(),this.RELEASE_SCOPE_MSG)},fetchPortfolioItemsInRelease:function(portfolioItemRecord){var filter=this.getContext().getTimeboxScope().getQueryFilter(),selectedPortfolioItemType=portfolioItemRecord.get("_type").toLowerCase(),parentArray=[];Ext.Array.each(this.portfolioItemTypes,function(p){return p.typePath.toLowerCase()!==selectedPortfolioItemType&&void parentArray.push("Parent")}),filter=parentArray.length>0?filter.and({property:parentArray.join("."),value:portfolioItemRecord.get("_ref")}):filter.and({property:"ObjectID",value:portfolioItemRecord.get("ObjectID")});var config={model:this.portfolioItemTypes[0].typePath,fetch:["ObjectID"],limit:"Infinity",pageSize:2e3,filters:filter};return this.fetchWsapiRecords(config)},buildBurndown:function(featuresInRelease){this.getDisplayBox().add({xtype:"rallychart",storeType:"Rally.data.lookback.SnapshotStore",storeConfig:this.getStoreConfig(featuresInRelease),calculatorType:"portfolioDrivenApps.releaseBurndownApp.BurndownCalculator",calculatorConfig:{stateFieldName:"ScheduleState",stateFieldValues:["Defined","In-Progress","Completed","Accepted"],startDate:this.getTimeboxScope().getRecord().get("ReleaseStartDate"),endDate:this.getTimeboxScope().getRecord().get("ReleaseDate")},chartConfig:this.getChartConfig()})},getStoreConfig:function(features){var featureOids=Ext.Array.map(features,function(f){return f.get("ObjectID")});return{find:{_TypeHierarchy:"HierarchicalRequirement",_ItemHierarchy:{$in:featureOids}},fetch:["ScheduleState","PlanEstimate"],hydrate:["ScheduleState"],sort:{_ValidFrom:1},removeUnauthorizedSnapshots:!0,useHttpPost:!0,limit:1/0}},getChartTitle:function(){return Ext.String.format("Release Burndown for {0}: {1}",this.portfolioItem.get("FormattedID"),this.portfolioItem.get("Name"))},getChartConfig:function(){return{chart:{zoomType:"xy",type:"column"},title:{text:this.getChartTitle(),style:{color:"#666",fontSize:"18px",fontFamily:"ProximaNova",fill:"#666"}},xAxis:{tickmarkPlacement:"on",tickInterval:20,title:{text:"Date",style:{color:"#444",fontFamily:"ProximaNova",textTransform:"uppercase",fill:"#444"}},labels:{style:{color:"#444",fontFamily:"ProximaNova",textTransform:"uppercase",fill:"#444"},formatter:function(){var d=new Date(this.value);return Rally.util.DateTime.format(d,"m/d/Y")}}},yAxis:[{title:{text:"Points",style:{color:"#444",fontFamily:"ProximaNova",textTransform:"uppercase",fill:"#444"}},labels:{style:{color:"#444",fontFamily:"ProximaNova",textTransform:"uppercase",fill:"#444"}}}],legend:{itemStyle:{color:"#444",fontFamily:"ProximaNova",textTransform:"uppercase"},borderWidth:0},tooltip:{backgroundColor:"#444",headerFormat:'<span style="display:block;margin:0;padding:0 0 2px 0;text-align:center"><b style="font-family:NotoSansBold;color:white;">{point.key}</b></span><table><tbody>',footerFormat:"</tbody></table>",pointFormat:'<tr><td class="tooltip-label"><span style="color:{series.color};width=100px;">●</span> {series.name}</td><td class="tooltip-point">{point.y}</td></tr>',shared:!0,useHTML:!0,borderColor:"#444"},plotOptions:{series:{marker:{enabled:!1}},area:{stacking:"normal"}}}}});

            Rally.launchApp('releaseBurndownApp', {
                name:"release-burndown-app",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .highcharts-tooltip{font-family:NotoSansBold;color:white}.tooltip-point{text-align:right;color:white}.tooltip-label{font-family:NotoSans;white-space:nowrap;font-size:13px;color:white}.etlDate{color:grey;font-family:NotoSans;font-style:italic}
    </style>
</head>
<body>
</body>
</html>
